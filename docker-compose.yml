version: '3'

services:
    nginx:
        container_name: socnet-nginx
        image: nginx:1.28.0-alpine
        working_dir: /var/www/app
        depends_on:
            - php
        ports:
            - 127.0.0.1:8089:80
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - .:/var/www/app
        networks:
            - app_network

    php:
        container_name: socnet-php
        build: ./docker/php/
        working_dir: /var/www/app
        depends_on:
            - mariadb
            - rabbitmq
        environment:
            TIMEZONE: Europe/Moscow
            COMPOSER_MEMORY_LIMIT: -1
        volumes:
            - .:/var/www/app
        networks:
            - app_network

    websocket:
        container_name: socnet-websocket
        build: ./docker/websocket/
        working_dir: /var/www/app
        depends_on:
            - php
            - mariadb
            - rabbitmq
        ports:
            - 127.0.0.1:8090:8090
        environment:
            - WEBSOCKET_PORT=8090
        volumes:
            - .:/var/www/app
        networks:
            - app_network

    mariadb:
        container_name: socnet-db
        image: mariadb:11.7.2
        restart: always
        env_file:
            - ./.env
            - ./.env.local
        ports:
            - 127.0.0.1:3309:3306
        volumes:
            - ./var/lib/mysql-data:/var/lib/mysql
        networks:
            - app_network

    redis:
        container_name: socnet-redis
        image: redis:7.4.3-alpine
        restart: unless-stopped
        ports:
            - 127.0.0.1:6679:6379
        volumes:
            - .:/var/www/app
        networks:
            - app_network

    rabbitmq:
        container_name: socnet-rabbitmq
        image: rabbitmq:3.9.15-management
        restart: always
        ports:
            - 127.0.0.1:5772:5672
            - 127.0.0.1:15772:15672
        env_file:
            - ./.env
            - ./.env.local
        volumes:
            - ./var/lib/rabbitmq_data:/var/lib/rabbitmq
        networks:
            - app_network

networks:
    app_network:
        driver: bridge